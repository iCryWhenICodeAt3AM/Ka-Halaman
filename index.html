<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=q, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <title>Document</title>
    <link rel="stylesheet" href="css/chat-bot.css">
</head>
<body>

    <hr>
    <label for="prompt">User:</label>
    <input type="text" name="prompt" id="prompt">
    <input type="file" name="imageInput" id="imageInput" accept="image/*">
    <input type="button" value="Send Message" id="sendMessageButton">
    <hr>
    <div id="conversationContainer"></div>
    <!-- <hr>
    <label for="response">Gemini Pro:</label> <br>
    <textarea name="response" id="response" cols="30" rows="10" disabled></textarea> -->

    
    <script type="importmap">
        {
            "imports": {
            "@google/generative-ai": "https://esm.run/@google/generative-ai"
            }
        }
    </script>
    <script type="module">
        import {
            GoogleGenerativeAI
        } from "@google/generative-ai";

        // Fetch your API_KEY
        const API_KEY = "AIzaSyB_DqoktUPNvFgQIf2vTW3R_e2yk4Tj0rM";

        // Access your API key (see "Set up your API key" above)
        const genAI = new GoogleGenerativeAI(API_KEY);

        // Conversation array to store user prompts and responses
        const conversation = [];

        document.getElementById("sendMessageButton").addEventListener("click", function () {
            const userPrompt = document.getElementById("prompt").value;
            const fileInputEl = document.getElementById("imageInput");
            const hasImage = fileInputEl.files.length > 0;

            if (hasImage) {
            const image = fileInputEl.files[0];
            sendMessageWithImage(userPrompt, image);
            } else {
            sendMessage(userPrompt);
            }
        });

        async function sendMessage(userPrompt) {
            // Store user message in the conversation
            conversation.push({ role: 'user', text: userPrompt });
            // Display the conversation
            displayConversation();

            const model = genAI.getGenerativeModel({ model: "gemini-pro" });
            const result = await model.generateContent(conversation.map(entry => entry.text));
            const response = await result.response;
            const text = response.text();
            console.log(text);
            // Store Gemini Pro's response in the conversation
            conversation.push({ role: 'gemini', text: text });
            // Display the conversation
            displayConversation();
            // // Display the current response
            // document.getElementById("response").value = text;
        }

        async function sendMessageWithImage(userPrompt, image) {
            // Store user message in the conversation
            conversation.push({ role: 'user', text: userPrompt, image: image });
            // Display the conversation
            displayConversation();

            const model = genAI.getGenerativeModel({ model: "gemini-pro-vision" });

            const imageUrl = URL.createObjectURL(image);

            const imageParts = await fileToGenerativePart(imageUrl, image.type);

            const result = await model.generateContent([userPrompt, imageParts]);
            const response = await result.response;
            const text = response.text();
            console.log(text);
            // Store Gemini Pro's response in the conversation
            conversation.push({ role: 'gemini', text: text, image: imageUrl });
            // Display the conversation
            displayConversation();
            // // Display the current response
            // document.getElementById("response").value = text;

            // Clear uploaded image
            document.getElementById("imageInput").value = "";
        }

        function displayConversation() {
            const conversationContainer = document.getElementById("conversationContainer");

            // Clear existing messages
            conversationContainer.innerHTML = '';

            // Display the conversation in the container
            conversation.forEach(entry => {
            const messageDiv = document.createElement("div");
            messageDiv.className = `message ${entry.role}-message`;

            // Interpret and apply formatting rules
            const formattedText = interpretFormatting(entry.text);
            messageDiv.innerHTML = `${entry.role}: <div class="formatted-text">${formattedText}</div>`;

            // Add a save button for Gemini Pro's responses
            if (entry.role === 'gemini') {
                const saveButton = document.createElement("button");
                saveButton.textContent = "Save to Journal";
                saveButton.className = "save-button";
                saveButton.onclick = () => saveToJournal(entry.text);
                messageDiv.appendChild(saveButton);
            }
            
            conversationContainer.appendChild(messageDiv);
            });

            // Scroll to the bottom to show the latest message
            conversationContainer.scrollTop = conversationContainer.scrollHeight;
        }

        // Function to interpret and apply formatting rules
        function interpretFormatting(text) {
            // Replace '*' with <b> for bold
            text = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            
            // Replace '*' with <li> for bullet points
            text = text.replace(/\*(.*?)\*/g, '<li>$1</li>');
            
            return text;
        }

        async function fileToGenerativePart(imageUrl, mimeType) {
            const base64EncodedDataPromise = fetch(imageUrl)
            .then(response => response.blob())
            .then(blob => {
                return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(blob);
                });
            });

            return {
            inlineData: {
                data: await base64EncodedDataPromise,
                mimeType: mimeType,
            },
            };
        }

        // Function to save Gemini Pro's response to the journal
        function saveToJournal(text) {
            // Here, you can implement the logic to save the response to the journal
            // For demonstration, let's log the response to the console
            console.log("Saving to Journal:", text);

                        
            // Add a new document to the "journal" subcollection with the formatted text
            journalRef.add({
                data: text,
                date: firebase.firestore.Timestamp.now(),
                from: "bot"
            })
            .then((docRef) => {
                console.log("Document written with ID: ", docRef.id);
            })
            .catch((error) => {
                console.error("Error adding document: ", error);
            });

        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/5.0.3/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.0.3/firebase-firestore.js"></script>
    <script src="js/firebase.js"></script>
</body>
</html>